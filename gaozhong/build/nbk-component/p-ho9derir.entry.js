import{r as t,c as s,h as i,g as h}from"./p-05c16912.js";import{D as e}from"./p-e34c4f58.js";let n,r;const o=class{constructor(i){t(this,i),this.isActive=!1,this.isUsing=!0,this.cursor="",this.board=null,this.canvasMain=null,this.sizes=[0,3,6,9],this.type="pen",this.drawStyle={},this.listenerMap=new Map,this.bingBtn=null,this.bingBtnLockClick=t=>{this.lockClick(t)},this.bingBtnPenClick=t=>{this.penClick(t)},this.changeDrawStyle(),this.brushOpen=s(this,"brushOpen",7)}async freshDom(){this.state=Math.random();const t=e.domQuerySelector(this.element,"nb-lock-pen");t&&t.freshLocation()}async initBoard(t,s){this.canvasMain=s;const i=t.DrawingBoard;n=i.EventType,r=i.BrushType;const h=e.domQuerySelector(this.element,".drawDiv");this.board=new i.Board(h,Object.assign(Object.assign({},i.defaultOptions),{defaultStrokeWidth:3,cursorColor:"#FFFFFF66",maxChgLineTm:500,primaryColor:"#2D8AE6",minGestureFinger:5,maxFingerDis:864,maxR:100,minR:30,maxGeatureDis:25,referDpi:192})),this.resize(),this.mainAddListener("canvas.removeAll.equments",()=>{this.board&&this.board.trigger(n.CLEAR)}),this.mainAddListener("canvas.moveToUpdateBrush",()=>{this.updateTransform()}),this.mainAddListener("canvas.switchXueke",()=>{this.resetDefault()}),this.mainAddListener("canvas.window.resize",()=>{this.resize()}),this.defaultPen()}defaultPen(){this.type="",this.brushSettingChange({detail:{tool:"pen",attr:"color",value:"#FF7E30"}})}async resetDefault(t=!0){this.isActive=!1,this.isUsing=!0,t&&this.board.trigger(n.CLEAR),this.changeDrawStyle(),this.resize(),e.domQuerySelector(this.element,"nb-brush").resetAll(!0,{color:{type:"color",index:1,flag:1}}).then(()=>{const t=this.bingBtn||e.domQuerySelector(this.element,"nb-lock-pen");t.lockBtnClick({tmpunlock:!0}),t.reset(),this.defaultPen()}),this.brushOpen.emit(!1)}async registerLockBtn(t){t&&(e.domQuerySelector(this.element,"nb-lock-pen").reset(),this.bingBtn=t,this.bingBtn.addEventListener("lockClick",this.bingBtnLockClick),this.bingBtn.addEventListener("penClick",this.bingBtnPenClick),this.state=Math.random())}async unregisterLockBtn(){this.bingBtn&&(this.bingBtn.removeEventListener("lockClick",this.bingBtnLockClick),this.bingBtn.removeEventListener("penClick",this.bingBtnPenClick),this.bingBtn=null,this.state=Math.random())}mainAddListener(t,s){this.canvasMain.addEventListener(t,s),this.listenerMap.set(t,s)}async updateTransform(t=!1){if(!(t||this.board&&this.isActive))return;let s=this.canvasMain.canvas,{x:i,y:h,scale:e}=this.canvasMain.view,n=this.canvasMain.W/s.width;if(8==this.canvasMain.getVersion()){const t=this.canvasMain.activeModule.forceAndMotion.appData;s=t.canvas,n=parseInt(s.style.width)/s.width;const r=t.canvasStage.scaleLayer,o=t.canvasStage.moveLayer;i=o.x,h=o.y;const l=o.toGlobal({x:0,y:0});i=l.x,h=l.y,e=r.scale}this.board.transformCanvas(e.x,e.y,i/n,h/n)}resize(){if(!this.canvasMain)return;let t=this.canvasMain.canvas,{width:s,height:i}=t;this.board.setSize(s,i,parseInt(t.style.width),parseInt(t.style.height)),this.updateTransform()}componentDidUnload(){this.bingBtn&&this.unregisterLockBtn(),this.listenerMap.forEach((t,s)=>{this.canvasMain.removeEventListener(s,t)}),this.canvasMain=null,this.listenerMap.clear(),this.board&&(this.board.dispose(),this.board=null)}brushSettingChange(t){if(!this.board)return;let s=t.detail,{attr:i,value:h}=s;switch(i){case"color":this.board.trigger(n.BRUSH_COLOR,{color:h});break;case"size":{let t=this.sizes[h];"reaser"===this.type&&(t*=10),this.board.trigger(n.LINE_SIZE,{size:t});break}}}brushToolChange(t){if(!this.board)return;let{type:s}=t.detail;if(this.type==s&&-1!=["reaser","pen","jinyong"].indexOf(s))return void console.log("重复了",s);this.type=""==s?"pen":s;let i={pen:r.LINE,arrow:r.ARROW,reaser:r.ERASER};"pen"==this.type?this.cursor="cursor-pen":"reaser"==this.type?this.cursor="cursor-reaser":"jinyong"==this.type&&(this.cursor="");let h=i[s];void 0!==h?(this.board.trigger(n.BRUSH_TYPE,{type:h}),this.board.trigger(n.ENABLE,{enable:!0}),this.isUsing=!0,this.changeLockBtnState(),this.changeDrawStyle()):"delate"===s?this.board.trigger(n.CLEAR):"cancel"===s?this.board.trigger(n.UNDO):"jinyong"===s&&(this.board.trigger(n.ENABLE,{enable:!1}),this.isUsing=!1,this.changeLockBtnState(),this.changeDrawStyle(),this.brushOpen.emit(!1))}async penClick(t){this.isActive=t.detail,this.changeDrawStyle(),this.isActive?(this.changeLockBtnState(),this.resize(),this.updateTransform(),this.brushOpen.emit(!0),this.defaultPen(),this.brushToolChange({detail:{type:this.type}})):(this.cursor="",this.changeLockBtnState(!1),this.resetDefault(!1),this.brushOpen.emit(!1))}async lockClick(t){this.canvasMain.changeCanvasLock(t.detail)}changeLockBtnState(t){(this.bingBtn||e.domQuerySelector(this.element,"nb-lock-pen")).lockBtnClick(null!=t?t:this.isUsing?this.isUsing:{tmpunlock:!0})}changeDrawStyle(){this.drawStyle=this.isUsing&&this.isActive?{pointerEvents:"auto",visibility:"visible"}:!this.isUsing&&this.isActive?{pointerEvents:"none",visibility:"visible"}:{pointerEvents:"none",visibility:"hidden"}}hideColorSetting(){e.domQuerySelector(this.element,"nb-brush").setSubmuneVisible(!1)}render(){return i("div",{class:"brush-content"},i("div",{class:"drawDiv "+this.cursor,style:this.drawStyle,onPointerDown:()=>{this.hideColorSetting()}}),i("nb-lock-pen",{style:{display:this.bingBtn?"none":""},onLockClick:t=>{this.lockClick(t)},onPenClick:t=>{this.penClick(t)}}),i("nb-brush",{defaultColor:1,class:"tools",style:{display:this.isActive?"block":"none"},onBrushSettingChange:t=>{this.brushSettingChange(t)},onBrushToolChange:t=>{this.brushToolChange(t)}}))}get element(){return h(this)}static get style(){return":host .brush-content{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}:host .brush-content .cursor-pen{cursor:url(assets/imgs/cursor_pen.ico) 0 100,auto}:host .brush-content .cursor-reaser{cursor:url(assets/imgs/cursor_reaser.ico) 0 100,auto}:host .brush-content .tools{z-index:1000000;position:absolute;bottom:var(--brush-bottom,70px);left:50%;margin-left:-145px;pointer-events:auto}:host .brush-content .drawDiv{position:absolute;pointer-events:auto;width:100%;height:100%}"}};export{o as nb_brush_container};